#!/bin/bash

## Copyright (C) 2025 - 2025 ENCRYPTED SUPPORT LLC <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -o errexit
set -o nounset
set -o errtrace
set -o pipefail

# shellcheck source=../libexec/helper-scripts/log_run_die.sh
source /usr/libexec/helper-scripts/log_run_die.sh

# shellcheck source=../libexec/helper-scripts/as_root.sh
source /usr/libexec/helper-scripts/as_root.sh

log_level=info

log info "Start"

config_dir='/etc/wlr-resize-watcher.d'
target_config_file="${config_dir}/45_configure-dynamic-resolution.conf"

default_resolution="1920x1080"

validate_bool_opt() {
  local orig_bool_opt bool_opt_lowercase

  orig_bool_opt="${1:-}"
  bool_opt_lowercase="${orig_bool_opt,,}"
  case "${bool_opt_lowercase}" in
    'true'|'t'|'y'|'yes'|'on'|'1')
      printf '%s\n' "true"
      ;;
    'false'|'f'|'n'|'no'|'off'|'0')
      printf '%s\n' "false"
      ;;
    *)
      true
      ;;
  esac
}

validate_resolution_opt() {
  local orig_resolution_opt resolution_opt_lowercase

  orig_resolution_opt="${1:-}"
  resolution_opt_lowercase="${orig_resolution_opt,,}"
  if [[ "${resolution_opt_lowercase}" =~ ^[0-9]+x[0-9]+$ ]]; then
    printf '%s\n' "${resolution_opt_lowercase}"
  fi
  ## Don't print anything if resolution_opt_lowercase fails the
  ## validation regex.
}

write_config_value() {
  local opt_key opt_val config_file_contents

  opt_key="${1:-}"
  opt_val="${2:-}"
  if [ -f "${target_config_file}" ]; then
    config_file_contents="$(stcatn "${target_config_file}")"
  else
    config_file_contents=""
  fi

  config_file_contents="$(sed "/${opt_key}=/d" <<< "${config_file_contents}")"
  ## Bash strips the file's trailing newline, so we have to put it back, but
  ## only if we loaded a non-empty file to begin with
  if [ -n "${config_file_contents}" ]; then
    config_file_contents+=$'\n'
  fi
  ## Then append the config option and a new trailing newline
  config_file_contents+="${opt_key}=${opt_val}"$'\n'

  overwrite "${target_config_file}" "${config_file_contents}" >/dev/null
}

set_bool_opt() {
  local config_option_id orig_bool_opt bool_opt

  config_option_id="${1:-}"
  orig_bool_opt="${2:-}"

  bool_opt="$(validate_bool_opt "${orig_bool_opt}")"
  if [ -z "${bool_opt}" ]; then
    log error "Option '${orig_bool_opt}' is invalid. Please use: yes/no, true/false, on/off, or 1/0."
    printf '%s\n' ""
    return 1
  fi
  write_config_value "${config_option_id}" "${bool_opt}"
  log notice "Saved: ${config_option_id} = ${bool_opt}"
  printf '%s\n' ""
  return 0
}

set_resolution_opt() {
  local config_option_id orig_resolution_opt resolution_opt

  config_option_id="${1:-}"
  orig_resolution_opt="${2:-}"

  resolution_opt="$(validate_resolution_opt "${orig_resolution_opt}")"
  if [ -z "${resolution_opt}" ]; then
    log error "'${orig_resolution_opt}' does not look like a screen resolution. Please use something like 1920x1080."
    printf '%s\n' ""
    return 1
  fi
  ## TOML requires strings to be quoted, thus we wrap the resolution opt in
  ## escaped quotes.
  write_config_value "${config_option_id}" "\"${resolution_opt}\""
  log notice "Saved: ${config_option_id} = ${resolution_opt}"
  printf '%s\n' ""
  return 0
}

configure_dynamic_resolution() {
  local config_option_list config_option_id_list config_option \
    config_option_id config_option_idx selected_idx opt_arg bool_opt resolution_opt did_change

  as_root

  if ! [ -d "${config_dir}" ]; then
    mkdir --parents -- "${config_dir}" || {
      log error "Could not create the configuration folder '${config_dir}'."
      return 1
    }
  fi
  if ! [ -f "${target_config_file}" ] && [ -e "${target_config_file}" ]; then
    log error "'${target_config_file}' exists but is not a regular file."
    return 1
  fi

  config_option_list=(
    'Turn dynamic resolution on or off'
    'Turn warning messages on or off (when dynamic resolution is refused)'
    "Set the normal default resolution"
    "Set the small default resolution (Xen only)"
    'Exit'
  )

  config_option_id_list=(
    'enable_dynamic_resolution'
    'warn_on_dynamic_resolution_refuse'
    'standard_default_resolution'
    'small_default_resolution'
    'exit'
  )

  printf '%s\n' ""

  while true; do
    printf '%s\n' 'What do you want to change?'
    printf '%s\n' ""
    config_option_idx=0
    for config_option in "${config_option_list[@]}"; do
      (( config_option_idx++ )) || true
      printf '%s\n' "  ${config_option_idx}: ${config_option}"
    done
    printf '%s\n' ""
    log question "Type a number and press Enter. Tip: just press Enter to turn ON dynamic resolution."
    read -r selected_idx opt_arg

    ## Default: pressing Enter does the most common thing (enable dynamic resolution).
    if [ -z "${selected_idx}" ]; then
      selected_idx="1"
      opt_arg="true"
    fi

    if ! [[ "${selected_idx}" =~ ^[0-9]+$ ]]; then
      log error "Please type a number (1 to ${#config_option_list[@]})."
      printf '%s\n' ""
      continue
    fi

    ## selected_idx starts at 1, not 0, so we have to adjust for that
    if (( selected_idx < 1 )) \
      || (( (selected_idx - 1) >= ${#config_option_list[@]} )); then
      log error "That number is out of range. Please choose 1 to ${#config_option_list[@]}."
      printf '%s\n' ""
      continue
    fi

    config_option_id="${config_option_id_list[selected_idx - 1]}"
    did_change=false

    case "${config_option_id}" in
      'enable_dynamic_resolution')
        if [ -n "${opt_arg:-}" ]; then
          bool_opt="${opt_arg}"
        else
          log question "Turn ON dynamic resolution? [Y/n] (Press Enter for Yes)"
          read -r bool_opt
          bool_opt="${bool_opt:-y}"
        fi
        if ! set_bool_opt "${config_option_id}" "${bool_opt}"; then
          continue
        fi
        did_change=true
        ;;

      'warn_on_dynamic_resolution_refuse')
        if [ -n "${opt_arg:-}" ]; then
          bool_opt="${opt_arg}"
        else
          log question "Show warning messages if dynamic resolution is refused? [y/N] (Press Enter for No)"
          read -r bool_opt
          bool_opt="${bool_opt:-n}"
        fi
        if ! set_bool_opt "${config_option_id}" "${bool_opt}"; then
          continue
        fi
        did_change=true
        ;;

      'standard_default_resolution')
        if [ -n "${opt_arg:-}" ]; then
          resolution_opt="${opt_arg}"
        else
          log question "Enter a resolution like 1920x1080. Press Enter to use ${default_resolution}."
          read -r resolution_opt
          resolution_opt="${resolution_opt:-$default_resolution}"
        fi
        if ! set_resolution_opt "${config_option_id}" "${resolution_opt}"; then
          continue
        fi
        did_change=true
        ;;

      'small_default_resolution')
        if [ -n "${opt_arg:-}" ]; then
          resolution_opt="${opt_arg}"
        else
          log question "Enter a resolution like 1920x1080. Press Enter to use ${default_resolution}."
          read -r resolution_opt
          resolution_opt="${resolution_opt:-$default_resolution}"
        fi
        if ! set_resolution_opt "${config_option_id}" "${resolution_opt}"; then
          continue
        fi
        did_change=true
        ;;

      'exit')
        log notice "Done. You can run this configuration tool again anytime to change another setting."
        printf '%s\n' ""
        return 0
        ;;

      *)
        ## This should be unreachable.
        log error "Internal error. Unreachable code hit!"
        exit 1
        ;;
    esac

    if [ "${did_change}" = true ]; then
      log notice "All set. If you want to change something else, just start this configuration tool again."
      printf '%s\n' ""
      return 0
    fi
  done
}

command -v id >/dev/null
command -v stcatn >/dev/null
command -v sed >/dev/null
command -v overwrite >/dev/null

log info "User documentation:
https://www.whonix.org/wiki/resize"

configure_dynamic_resolution

log info "Saved settings file '${target_config_file}':"
printf '%s\n' "########################################"
stcatn "${target_config_file}"
printf '%s\n' "########################################"
printf '%s\n' ""

if [ -n "${SUDO_USER-}" ]; then
  log info "Restarting 'wlr-resize-watcher.service'..."
  xdg_runtime_dir="/run/user/$(id --user -- "$SUDO_USER")"
  log_run info sudo --user="$SUDO_USER" -- env XDG_RUNTIME_DIR="$xdg_runtime_dir" systemctl --user restart wlr-resize-watcher.service
else
  log notice "Cannot automatically restart the wlr-resize-watcher.service because the environment variable SUDO_USER is unavailable."
  log warn "To apply changes: reboot, or run this (without sudo) as your normal user:"
  log warn "systemctl --user restart wlr-resize-watcher.service"
fi

log notice "Success."
